# Scripts Documentation

**Purpose**: Generic reusable scripts for asset management and data synchronization  
**Last Updated**: 2025-10-20

---

## 📁 Directory Structure

```
scripts/
├── README.md                    # This file
├── download-assets.js           # Download images from Figma MCP
├── upload-to-cdn.sh            # Upload to Cloudinary CDN
├── update-entities.js          # Update database with CDN URLs
├── sync-entity-data.js         # Sync names/prices/metadata
├── download-results.json       # Latest download results
├── cdn-urls.json               # Latest CDN URLs
├── update-response.json        # Latest API response
├── mcp/                        # MCP server implementation
│   ├── mcp-unified-server.ts   # Unified MCP + REST server
│   ├── helpers/                # Data loaders
│   └── routes/                 # (legacy, not used in unified)
└── .archive/                   # Old/deprecated scripts
```

---

## Active Scripts

### Asset Management Workflow

#### `download-assets.js`

**Purpose**: Download assets from remote source with verified mapping

**Usage**:
```bash
node download-assets.js
```

**What it does**:
1. Downloads 23 product images from Figma MCP localhost server
2. Uses verified source → database ID mapping
3. Validates file sizes (>100 bytes)
4. Saves to `public/assets/products/product-{id}.png`
5. Generates results report: `download-results.json`

**Output**:
- `public/assets/products/product-100.png` through `product-123.png`
- `download-results.json` - Download results with success/failure details

**Example Output**:
```
✅ Successful: 23/23
❌ Failed: 0/23
```

---

#### `upload-to-cdn.sh`

**Purpose**: Upload local assets to CDN (Cloudinary)

**Usage**:
```bash
bash upload-to-cdn.sh
```

**What it does**:
1. Reads assets from `../public/assets/products/`
2. Generates SHA1 signatures for authentication
3. Uploads to CDN using cURL
4. Saves URLs to `cdn-urls.json`

**Requirements**:
- Bash shell
- `curl` command
- `openssl` for SHA1 generation
- Images in `public/assets/products/`

**Configuration**:
```bash
CLOUD_NAME="dtes5pcfm"
API_KEY="279415635918263"
FOLDER="skullcandy-products"
IMAGE_DIR="../public/assets/products"
```

**Output**:
- `cdn-urls.json` - Array of uploaded asset URLs with entity IDs

**Example Output**:
```
✅ Successful uploads: 23/23
❌ Failed uploads: 0/23
```

---

#### `update-entities.js`

**Purpose**: Batch update database entities with CDN asset URLs

**Usage**:
```bash
node update-entities.js
```

**What it does**:
1. Reads `cdn-urls.json`
2. Creates batch update payload
3. Sends PATCH request to `/products/batch` API
4. Saves response to `update-response.json`

**API Endpoint**:
```
PATCH https://devday-aavn-d5284e914439.herokuapp.com/api/products/batch
```

**Payload Format**:
```json
{
  "updates": [
    {
      "id": 100,
      "data": {
        "image": "https://res.cloudinary.com/dtes5pcfm/image/upload/v1760931715/skullcandy-products/product-100.png"
      }
    }
  ]
}
```

**Output**:
- `update-response.json` - API response with updated entities

**Example Output**:
```
✅ Batch update successful!
📝 Response: 200 OK
```

---

#### `sync-entity-data.js`

**Purpose**: Sync entity data (names, prices, metadata) from source

**Usage**:
```bash
node sync-entity-data.js
```

**What it does**:
1. Uses entity data extracted from design source
2. Creates batch update for names, prices, and metadata
3. Sends PATCH request to `/products/batch` API

**Note**: 
- Creator field is accepted but not persisted by backend API
- Contains manual mapping of 23 entities

**When to use**:
- After design source updates entity names or prices
- Manual verification recommended before running

---

## Complete Workflow

### Full Asset Re-Sync from Source

**When**: Assets or data change in design source

**Steps**:
```bash
# 1. Download fresh assets from source
node download-assets.js

# 2. Upload to CDN
bash upload-to-cdn.sh

# 3. Update database with new URLs
node update-entities.js

# 4. (Optional) Update names/prices/metadata
node sync-entity-data.js
```

**Expected Results**:
- All 23 entities have updated assets
- Database reflects latest source data
- 100% success rate across all operations

---

## Data Files

### Active Data Files (Current Workflow Results)

| File | Purpose | Generated By | Keep? |
|------|---------|--------------|-------|
| `download-results.json` | Latest asset download results | `download-assets.js` | ✅ Yes |
| `cdn-urls.json` | Latest CDN upload results | `upload-to-cdn.sh` | ✅ Yes |
| `update-response.json` | Latest database update response | `update-entities.js` | ✅ Yes |

**Why keep these?**
- Verification of last successful sync
- Reference for current CDN URLs
- Debugging failed uploads or updates

### Archived Data Files

**Location**: `scripts/.archive/old-data/`

Older JSON files from previous sync attempts (kept for historical reference):
- `all-products.json` - Entity snapshot (Oct 18)
- `downloaded-images.json` - Old download results
- `figma-sync-response.json` - Previous source sync
- `update-products-batch.json` - Old batch payload

### Data File Locations

- **Input**: `../public/assets/products/*.png`
- **Active Output**: `scripts/*.json` (3 files)
- **Archive**: `scripts/.archive/old-data/`
- **Deprecated Scripts**: `scripts/.archive/`

---

## Entity ID Mapping

**Database IDs**: 100-111, 113-123 (23 total, ID 112 missing)

**Source to Database Mapping**:
```
Source Product 01 → DB ID 100 (Cryptic Hacker)
Source Product 02 → DB ID 101 (Frosty Snow Queen)
...
Source Product 12 → DB ID 111 (Oceanic Sea Princess)
Source Product 13 → DB ID 113 (Mountain Angel Goat) [skips 112]
...
Source Product 23 → DB ID 123 (Forever Young Peter Pan)
```

Full mapping available in: `download-assets.js` (lines 11-33)

---

## Archived Scripts

**Location**: `scripts/.archive/`

These scripts are kept for reference but replaced by newer versions:

- `download-images.js` - Replaced by `download-assets.js`
- `sync-figma-data.js` - Replaced by `sync-entity-data.js`
- `update-backend.js` - Initial sync script (obsolete)
- `upload-images.sh` - Replaced by `upload-to-cdn.sh`
- `upload-to-cloudinary.js` - Unused Node.js version
- `validate-mapping.js` - Development validation tool
- `list-figma-nodes.js` - Development exploration tool

---

## Troubleshooting

### Asset Download Fails

**Error**: "File too small (19 bytes)"

**Cause**: Source server error or asset not available

**Solution**:
1. Ensure source application is running
2. Check MCP server is running on localhost:3845
3. Verify node IDs are correct
4. Use `get_design_context` to get fresh asset URLs

---

### Upload to CDN Fails

**Error**: 401 Unauthorized

**Cause**: Invalid signature

**Solution**:
1. Verify `API_SECRET` environment variable is set
2. Check timestamp is current (not expired)
3. Ensure parameters are alphabetically sorted before signing

---

### Database Update Fails

**Error**: 400 Bad Request

**Cause**: Invalid payload structure

**Solution**:
1. Verify payload uses `{id, data: {image}}` structure (not `{id, image}`)
2. Check all entity IDs exist in database
3. Ensure asset URLs are valid HTTPS URLs

---

### File Not Found

**Error**: "ENOENT: no such file or directory"

**Cause**: Incorrect file path

**Solution**:
1. Verify assets exist in `public/assets/products/`
2. Check script is run from `scripts/` directory
3. Use relative path `../public/assets/products/`

---

## Environment Variables

### Required for CDN Upload

```bash
export CDN_API_SECRET="your-api-secret-here"
```

**How to set**:
```bash
# Temporary (current session)
export CDN_API_SECRET="abc123"

# Permanent (add to ~/.bashrc or ~/.zshrc)
echo 'export CDN_API_SECRET="abc123"' >> ~/.bashrc
```

---

## Related Documentation

- [Backend API](../docs/api/backend-api.md) - Entity database API
- [Cloudinary API](../docs/api/cloudinary-api.md) - CDN API
- [Figma MCP](../docs/api/figma-mcp.md) - Design data extraction
- [Implementation Timeline](../.private/IMPLEMENTATION_TIMELINE.md)

---

## Quick Reference

### Manual Entity Fetch

```bash
# Get all entities from database
curl https://devday-aavn-d5284e914439.herokuapp.com/api/products > all-entities.json

# Get specific entity
curl https://devday-aavn-d5284e914439.herokuapp.com/api/products/100
```

### Verify Asset URLs

```bash
# Check if CDN asset loads
curl -I https://res.cloudinary.com/dtes5pcfm/image/upload/v1760931715/skullcandy-products/product-100.png

# Expected: HTTP/2 200
```

### Check File Sizes

```bash
# List all assets with sizes
ls -lh ../public/assets/products/

# Expected: 779KB - 1,400KB per asset
```

---

**Last Updated**: October 20, 2025  
**Maintained By**: GitHub Copilot Agent  
**Status**: ✅ Production Ready
